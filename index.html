<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turnos Urología San Felipe</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/flatpickr.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/flatpickr/4.6.13/l10n/es.min.js"></script>

    <style>
        .feriado-arg { background-color: #fef08a !important; color: #854d0e !important; border-radius: 50%; }
        /* Animación para resaltar el campo de fecha si no lo ven */
        .resaltar { border: 2px solid #2563eb !important; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
    </style>
</head>
<body class="bg-slate-200 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md border-t-8 border-blue-600">
        <h2 class="text-xl font-black text-center text-slate-800 mb-6 uppercase">Agenda de Turnos</h2>

        <form id="appointmentForm" onsubmit="enviarTurno(event)" class="space-y-4">
            
            <input type="text" id="nombre" placeholder="Nombre del Paciente" required class="w-full p-4 border border-slate-200 rounded-2xl outline-none focus:border-blue-500 bg-slate-50">
            
            <div class="grid grid-cols-2 gap-4">
                <input type="number" id="dni" placeholder="DNI" required class="w-full p-4 border border-slate-200 rounded-2xl outline-none focus:border-blue-500 bg-slate-50">
                <select id="mutual" class="w-full p-4 border border-slate-200 rounded-2xl outline-none bg-slate-50">
                    <option value="PARTICULAR">Particular</option>
                    <option value="OSFATLYF">OSFATLYF</option>
                    <option value="PAMI">PAMI</option>
                    <option value="IOMA">IOMA</option>
                </select>
            </div>

            <div class="bg-blue-600 p-1 rounded-2xl">
                <input type="text" id="fecha" readonly placeholder="CLIC AQUÍ PARA ELEGIR DÍA" 
                       class="w-full p-4 bg-white rounded-xl text-center font-black text-blue-700 cursor-pointer border-none outline-none">
            </div>

            <div id="slotSection" class="hidden border-2 border-dashed border-slate-200 p-4 rounded-2xl">
                <p class="text-[10px] font-bold text-slate-400 text-center mb-2 uppercase">Horarios Libres:</p>
                <div id="gridHorarios" class="grid grid-cols-3 gap-2"></div>
            </div>

            <button type="submit" class="w-full bg-green-600 text-white py-5 rounded-2xl font-black hover:bg-green-700 shadow-xl transition-all uppercase tracking-widest">
                Confirmar por WhatsApp
            </button>
        </form>
    </div>

    <script>
        // CONFIGURACIÓN (Verifica que tu URL de Google sea correcta)
        const MI_WHATSAPP = "5493364676933"; 
        const MI_APPSCRIPT_URL = "https://script.google.com/macros/s/AKfycbzZcRDg4km_i5gF2WQxaTywOalynrAVe3U98xkLyo1GffolfmV_JUf5mpwnSLRtgTBX/exec"; 

        const feriados2026 = ["2026-01-01", "2026-02-16", "2026-02-17", "2026-03-24", "2026-04-02", "2026-04-03", "2026-05-01", "2026-05-25", "2026-06-20", "2026-07-09", "2026-12-08", "2026-12-25"];
        let horaSeleccionada = "";

        // INICIALIZACIÓN CON RETARDO PARA EVITAR ERRORES EN GITHUB
        window.onload = function() {
            setTimeout(() => {
                flatpickr("#fecha", {
                    locale: "es",
                    minDate: "today",
                    dateFormat: "d-m-Y",
                    disable: [
                        function(date) {
                            const d = date.getDay();
                            const s = date.toISOString().split('T')[0];
                            return (d === 0 || d === 2 || d === 4 || d === 6 || feriados2026.includes(s));
                        }
                    ],
                    onDayCreate: (d, s, f, el) => {
                        if (feriados2026.includes(el.dateObj.toISOString().split('T')[0])) el.classList.add("feriado-arg");
                    },
                    onChange: (sel, str) => {
                        buscarHoras(str);
                    }
                });
            }, 500); // Espera medio segundo para asegurar que la librería cargó
        };

        async function buscarHoras(fecha) {
            const grid = document.getElementById('gridHorarios');
            document.getElementById('slotSection').classList.remove('hidden');
            grid.innerHTML = "<p class='col-span-3 text-center text-xs'>Cargando...</p>";

            const turnos = ["15:00", "15:15", "15:30", "15:45", "16:00", "16:15", "16:30", "16:45", "17:00", "17:15", "17:30", "17:45"];

            try {
                const r = await fetch(`${MI_APPSCRIPT_URL}?fecha=${fecha}`);
                const ocupados = await r.json();
                grid.innerHTML = "";
                turnos.forEach(h => {
                    const estaOcupado = ocupados.includes(h);
                    const b = document.createElement('button');
                    b.type = "button";
                    b.innerText = h;
                    b.className = estaOcupado ? "p-3 bg-red-50 text-red-200 rounded-xl text-xs font-bold cursor-not-allowed" : "p-3 bg-blue-50 text-blue-600 rounded-xl text-xs font-bold border border-blue-100 hover:bg-blue-600 hover:text-white";
                    if(!estaOcupado) b.onclick = () => {
                        horaSeleccionada = h;
                        document.querySelectorAll('#gridHorarios button').forEach(btn => btn.classList.remove('bg-blue-600', 'text-white'));
                        b.classList.add('bg-blue-600', 'text-white');
                    };
                    grid.appendChild(b);
                });
            } catch(e) { grid.innerHTML = "<p class='col-span-3 text-center'>Error de conexión</p>"; }
        }

        function enviarTurno(e) {
            e.preventDefault();
            if(!horaSeleccionada) return alert("Elige una hora azul");

            const n = document.getElementById('nombre').value;
            const d = document.getElementById('dni').value;
            const m = document.getElementById('mutual').value;
            const f = document.getElementById('fecha').value;

            // Registro en Google
            fetch(MI_APPSCRIPT_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify({nombre:n, dni:d, mutual:m, fecha:f, hora:horaSeleccionada}) });

            // WhatsApp
            const txt = `*NUEVO TURNO*\n\n*Paciente:* ${n}\n*DNI:* ${d}\n*Mutual:* ${m}\n*Fecha:* ${f}\n*Hora:* ${horaSeleccionada}`;
            window.open(`https://api.whatsapp.com/send?phone=${MI_WHATSAPP}&text=${encodeURIComponent(txt)}`, '_blank');
        }
    </script>
</body>
</html>


